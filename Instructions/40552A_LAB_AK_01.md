# Lab Answer Key:  Microsoft Security Workshop: Managing Identity
# Lab: AD Privileged Access Management (PAM) and Just In Time Administration (JIT)

## Exercise 1: Implement PAM and JIT Infrastructure

#### Task 1: Prepare ADATUM Active Directory

1.   Sign in to the LON-DC1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**. 
3.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task1-01.ps1):

```
New-ADGroup –Name CorpAdmins –GroupCategory Security –GroupScope Global –SamAccountName CorpAdmins
New-ADUser –SamAccountName CorpAdmin01 –Name CorpAdmin01
Add-ADGroupMember –Identity CorpAdmins –Members CorpAdmin01
$password = ConvertTo-SecureString 'Pa55w.rd' –AsPlainText –Force
Set-ADAccountPassword –Identity CorpAdmin01 –NewPassword $password
Set-ADUser –Identity CorpAdmin01 –Enabled 1 -DisplayName 'CorpAdmin 01'
```

4.   Click **Start** and then click **Windows Administrative Tools**. In the list of tools, click **Group Policy Management**.
5.   In the Group Policy Management console, navigate to the **Default Domain Controllers Policy** GPO. 
6.   If prompted with the message stating **You have selected a link to a Group Policy Object (GPO). Except for changes to link properties, changes you make here are global to the GPO and will impact all other locations where the GPO is linked**, select the checkbox **Do not show this message again** and click **OK**.
7.   Right-click the **Default Domain Controllers Policy** GPO and click **Edit**. 
8.   In the Group Policy Management Editor window, under the Default Domain Controllers Policy tree, navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Audit Policy**.
9.   In the details pane, right click **Audit account management** and click **Properties**. Click **Define these policy settings** and enable both **Success** and **Failure** auditing
10.   In the similar manner, enable **Success** and **Failure** for **Audit directory service access**. 
11.   Right-click **Start**, click **Run**, in the **Open** text box type **cmd**, and click **OK**. 
12.   From the Command Prompt window, run the following:

```
gpupdate /force /target:computer
```

13.   From the **Administrator: Windows PowerShell ISE** window, run the following (where `172.16.0.200` is the IP address of **PAM-DC1**) (F:\\Labfiles\\Scripts\\Ex1Task1-02.ps1):

```
Add-DnsServerZoneDelegation –Name "adatum.com" -ChildZoneName “priv” -NameServer “PAM-DC1.priv.adatum.com” -IPAddress “172.16.0.200”
```

14.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task1-03.ps1):

```
New-Item -Path c:\corpfs -ItemType directory
New-SMBShare –Name corpfs –Path 'c:\corpfs' –ChangeAccess 'ADATUM\CorpAdmins'
$acl = Get-Acl c:\corpfs
$car = New-Object System.Security.AccessControl.FileSystemAccessRule( "ADATUM\CorpAdmins", "FullControl", "Allow")
$acl.SetAccessRule($car)
Set-Acl c:\corpfs $acl
```

15.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task1-04.ps1):

```
Invoke-Command -ComputerName lon-cl1 -ScriptBlock {Add-LocalGroupMember -Group Administrators -Member 'ADATUM\CorpAdmin01'}
```

#### Task 2: Prepare PRIV Active Directory

1.   Sign in to the PAM-DC1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**
3.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-01.ps1):

```
$password = ConvertTo-SecureString "Pa55w.rd" –AsPlainText –Force
New-ADUser –SamAccountName MIMMA –Name MIMMA
Set-ADAccountPassword –Identity MIMMA –NewPassword $password
Set-ADUser –Identity MIMMA –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMMonitor –Name MIMMonitor -DisplayName MIMMonitor
Set-ADAccountPassword –Identity MIMMonitor –NewPassword $password
Set-ADUser –Identity MIMMonitor –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMComponent –Name MIMComponent -DisplayName MIMComponent
Set-ADAccountPassword –Identity MIMComponent –NewPassword $password
Set-ADUser –Identity MIMComponent –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMSync –Name MIMSync
Set-ADAccountPassword –Identity MIMSync –NewPassword $password
Set-ADUser –Identity MIMSync –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMService –Name MIMService
Set-ADAccountPassword –Identity MIMService –NewPassword $password
Set-ADUser –Identity MIMService –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName SharePoint –Name SharePoint
Set-ADAccountPassword –Identity SharePoint –NewPassword $password
Set-ADUser –Identity SharePoint –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName SqlServer –Name SqlServer
Set-ADAccountPassword –Identity SqlServer –NewPassword $password
Set-ADUser –Identity SqlServer –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName BackupAdmin –name BackupAdmin
Set-ADAccountPassword –Identity BackupAdmin –NewPassword $password
Set-ADUser –Identity BackupAdmin –Enabled 1 -PasswordNeverExpires 1
New-ADUser -SamAccountName MIMAdmin -Name MIMAdmin
Set-ADAccountPassword –Identity MIMAdmin -NewPassword $password
Set-ADUser -Identity MIMAdmin -Enabled 1 -PasswordNeverExpires 1
Add-ADGroupMember "Domain Admins" SharePoint
Add-ADGroupMember "Domain Admins" MIMService
```

4.   Click **Start** and then click **Windows Administrative Tools**. In the list of tools, click **Group Policy Management**.
5.   In the **Group Policy Management** console, navigate to the **Default Domain Controllers Policy**. 
6.   If prompted with the message stating **You have selected a link to a Group Policy Object (GPO). Except for changes to link properties, changes you make here are global to the GPO and will impact all other locations where the GPO is linked**, select the checkbox **Do not show this message again** and click **OK**.
7.   Right-click the **Default Domain Controllers Policy** object and click **Edit**. 
8.   In the **Group Policy Management Editor** window, under the **Default Domain Controllers Policy** tree, navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Audit Policy**.
9.   In the details pane, right click **Audit account management** and click **Properties**. Click **Define these policy settings** and enable both **Success** and **Failure** auditing
10.   Navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Kerberos Policy**.
11.   In the **Details** pane, double-click on **Maximum lifetime for user ticket**. Set the number of hours to **1**. Note that this automatically configures the following values:

  -   Maximum lifetime for service ticket: **10 minutes**
  -   Maximum lifetime for user ticket renewal: **7 days**

12.   Switch to the **Group Policy Management** window, navigate to the **Default Domain Policy** object and open it in in the **Group Policy Management Editor**.
13.   In the editor window, expand **Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies** and select **User Rights Assignment**
14.   On the **Details** pane, right-click on **Deny log on as a batch job** and click **Properties**.
15.   Enable the **Define these Policies Settings** checkbox, click **Add User or Group**, and in the **User and group names** field, type **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent** and click **OK**.
16.   In the similar manner, set the **Deny log on through Remote Desktop Services** to **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent**.
17.   Right-click **Start**, click **Run**, in the **Open** text box type **cmd**, and click **OK**. 
18.   From the Command Prompt window, run the following:

```
gpupdate /force /target:computer
```

19.   From **Administrator: Windows PowerShell ISE**, run the following (where `<IP address of LON-DC1>` is the IP address of **LON-DC1**) (F:\\Labfiles\\Scripts\\Ex1Task2-02.ps1):

```
Add-DnsServerConditionalForwarderZone –Name "adatum.com" –MasterServers 172.16.0.100
```

20.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-03.cmd):

```
setspn -S http/pam-svr1.priv.adatum.com PRIV\SharePoint
setspn -S http/pam-svr1 PRIV\SharePoint
setspn -S FIMService/pam-svr1.priv.adatum.com PRIV\MIMService
setspn -S FIMService/pam-svr1 PRIV\MIMService
```

21.   Start **Active Directory Users and Computers**. 
22.   Right-click the **domain priv.adatum.com** and, in the right-click menu, select **Delegate Control**. 
23.   In the **Delegation of Control Wizard**, on the **Users and Groups** page, click **Add**. 
24.   In the **Select Users, Computers, or Groups** window, type **mimcomponent; mimmonitor; mimservice** and click **OK**. 
25.   In the list of common tasks, enable the **Create, delete, and manage user accounts** and **Modify the membership of a group** checkboxes then click **Next** and **Finish**.
26.   Repeat steps 22 - 25, but this time, in step 24 specify the **PRIV\\MIMAdmin** user account and in step 25 select **Create a custom task to delegate**. 
27.   On the **Active Directory Object Type** page, accept the default **This folder, existing objects in this folder, and creation of new objects in this folder** option.
28.   On the **Permissions** page, ensure that the **General** check box is enabled.
29.   In the **Permissions** list, select the following then click **Next** and **Finish**: 

  -   **Read**
  -   **Write**
  -   **Create all Child Objects** 
  -   **Delete all Child Objects** 
  -   **Read All Properties** 
  -   **Write All Properties** 
  -   **Migrate SID History**

30.   Repeat steps 22-25, in step 24 specify the **PRIV\\MIMAdmin** user account again and in step 25 select **Create a custom task to delegate ** again. 

  > **Note:** Note that permissions you will assign next are different from the ones applied in steps 26-29. 

31.   On the **Active Directory Object Type** page, select **Only the following objects in this folder** option and, in the list of objects, enable the **User** objects checkbox and click **Next**.
32.   On the **Permissions** page, ensure that the **General** check box is enabled.
33.   In the **Permissions** list, select the following, then click **Next** and **Finish**: 

  -   **Change password**
  -   **Reset password**

34.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-04.cmd):

```
dsacls "cn=adminsdholder,cn=system,dc=priv,dc=adatum,dc=com" /G PRIV\mimservice:WP;"member" 
dsacls "cn=adminsdholder,cn=system,dc=priv,dc=adatum,dc=com" /G PRIV\mimcomponent:WP;"member"
```

35.   From **Administrator: Windows PowerShell ISE**, run the following (confirm when prompted whether you want to perform this action) (F:\\Labfiles\\Scripts\\Ex1Task2-05.ps1):

```
$of = Get-ADOptionalFeature –Filter "name -eq 'privileged access management feature'"
Enable-ADOptionalFeature $of -Scope ForestOrConfigurationSet -Target "priv.adatum.com"
```

36.   To authorize the MIM administrators and MIM Service account to create and update shadow principals, start **ADSIEdit**.
37.   In the **ADSI Edit** window, from the **Actions** menu, connect to the **Configuration** naming context
38.   Navigate to **CN=Configuration, CN=Services**.
39.   Right click on **CN=Shadow Principal Configuration** and click **Properties**. 
40.   In the **Properties** dialog box, switch to the **Security** tab.
41.   Add the **PRIV\\MIMService** and **PRIV\\MIMAdmin** accounts that will be creating additional PAM groups. For each of them, grant **Write**, **Create all child objects**, and **Delete all child objects** permissions.
42.   Change to **Advanced Security** settings. 
43.   Set the **PRIV\\MIMService** and **PRIV\\MIMAdmin** permissions to apply to **This object and all descendant objects**.
44.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-06.cmd):

```
dsacls "CN=AuthN Policies,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:RPWPRCWD;;msDS-AuthNPolicy /i:s
dsacls "CN=AuthN Policies,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:CCDC;msDS-AuthNPolicy
dsacls "CN=AuthN Silos,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:RPWPRCWD;;msDS-AuthNPolicySilo /i:s
dsacls "CN=AuthN Silos,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:CCDC;msDS-AuthNPolicySilo
```

#### Task 3: Prepare PAM-SVR1

1.   Log in to the PAM-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**.
3.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-01.ps1):

```
Install-WindowsFeature Web-WebServer,Net-Framework-Features,rsat-ad-powershell,Web-Mgmt-Tools, Windows-Identity-Foundation,Server-Media-Foundation,Xps-Viewer -IncludeAllSubFeature -Source F:\Tools\WS2016\sources\sxs -Restart
```

4.   To configure the server security policy, start the **Local Security Policy** console from the **Tools** menu in **Server Manager**.
5.   Navigate to **Local Policies > User Rights Assignment**. 
6.   In the details pane, right click **Log on as a service**, and, in the right-click menu, click **Properties**. 
7.   From the **Add User or Group** dialog box, add **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\SharePoint; PRIV\\MIMComponent; PRIV\\SqlServer ** and click **OK** twice. 
8.   In the details pane, right click **Deny access to this computer from the network**, and, in the right-click menu, click **Properties**. 
9.   From the **Add User or Group** dialog box, add **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent** and click **OK** twice.
10.   In the details pane, right click **Deny log on locally**, and, in the right-click menu, click Properties. 
11.   From the **Add User or Group** dialog box, add **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent** and click **OK** twice.
12.   To add MIMAdmin and SharePoint accounts to the local Administrators group, start **Computer Management** console from the **Tools** menu in **Server Manager**.
13.   In the **Computer Management** console, click **Local Users and Groups**.
14.   Expand the **Groups** folder, double-click **Administrators**, in the **Administrator Properties** dialog box, click **Add**.
15.   From the **Select Users, Computers, Service Accounts, or Groups** dialog box, add **PRIV\\MIMAdmin** and **PRIV\\SharePoint**. 
16.   Right-click **Start**, click **Run**, in the **Open** text box type **cmd**, and click **OK**. 
17.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-02.cmd):

```
iisreset /STOP
C:\Windows\System32\inetsrv\appcmd.exe unlock config /section:windowsAuthentication -commit:apphost 
iisreset /START
```

18.   Log off and log back on with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

19.   Start **File Explorer**, browse to the **F:\\Tools\\SQLServer2017** folder, right click the **SQLServer2017-x64-ENU.ISO** file and click **Mount**. Identify the drive assigned to the mounted ISO file.
20.   Right-click **Start** and click **Command Prompt (Admin)**. When prompted, in the **User Account Control** dialog box, click **Yes**.
21.   From the **Administrator: Command Prompt** window, change the current directory to the root of the drive assigned to the mounted ISO file.
22.   From the **Administrator: Command Prompt** window, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-03.cmd):

```
.\setup.exe /Q /IACCEPTSQLSERVERLICENSETERMS /ACTION=install /FEATURES=SQL /INSTANCENAME=MSSQLSERVER /SQLSVCACCOUNT="PRIV\SqlServer" /SQLSVCPASSWORD=”Pa55w.rd” /AGTSVCSTARTUPTYPE=Automatic /AGTSVCACCOUNT="NT AUTHORITY\Network Service" /SQLSYSADMINACCOUNTS="PRIV\MIMAdmin"
```

  > **Note:**  This command runs unattended installation of SQL Server. Wait for the SQL Server 2016 installation to complete. 

23.   Next, start **Windows PowerShell ISE** as **Administrator** and, from **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-04.ps1):

```
Get-Service –Name wuauserv | Set-Service –StartupType Automatic 
Get-Service –Name wuauserv | Start-Service
```

24.   In **File Explorer**, browse to the **F:\\Tools\\SharePoint2016** folder, right click the **officeserver.img** file and click **Mount**. Identify the drive letter assigned to the mounted ISO file. 
25.   Next, you will install SharePoint 2016. From the **Administrator: Command Prompt**, switch to the drive where you mounted the SharePoint 2016 installation media and run the following (F:\\Labfiles\\Scripts\\Ex1Task3-05.cmd):

```
.\prerequisiteinstaller.exe /sqlncli:"F:\Tools\SharePoint2016\prerequisites\sqlncli.msi" /idfx11:"F:\Tools\SharePoint2016\prerequisites\MicrosoftIdentityExtensions-64.msi" /sync:"F:\Tools\SharePoint2016\prerequisites\Synchronization.msi" /appfabric:"F:\Tools\SharePoint2016\prerequisites\WindowsServerAppFabricSetup_x64.exe" /kb3092423:"F:\Tools\SharePoint2016\prerequisites\AppFabric-KB3092423-x64-ENU.exe" /msipcclient:"F:\Tools\SharePoint2016\prerequisites\setup_msipc_x64.exe" /wcfdataservices56:"F:\Tools\SharePoint2016\prerequisites\WcfDataServices.exe" /odbc:"F:\Tools\SharePoint2016\prerequisites\msodbcsql.msi" /msvcrt11:"F:\Tools\SharePoint2016\prerequisites\vcredist_x64.exe" /msvcrt14:"F:\Tools\SharePoint2016\prerequisites\vc_redist.x64.exe" /dotnetfx:"F:\Tools\SharePoint2016\prerequisites\NDP46-KB3045557-x86-x64-AllOS-ENU.exe"
```

26.   This will start the **SharePoint 2016 Products Preparation Tool**. When prompted, accept the default settings and wait till the installation of the prerequisites completes. 
27.   Click **Finish** to restart PAM-SVR1.
28.   Once PAM-SVR1 is back online, log in back to the PAM-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

29.   Mount again the SharePoint 2016 installation media, start **Command Prompt (Admin)**, switch to the drive where you mounted the SharePoint 2016 installation media and re-run the following (F:\\Labfiles\\Scripts\\Ex1Task3-05.cmd):

```
.\prerequisiteinstaller.exe /sqlncli:"F:\Tools\SharePoint2016\prerequisites\sqlncli.msi" /idfx11:"F:\Tools\SharePoint2016\prerequisites\MicrosoftIdentityExtensions-64.msi" /sync:"F:\Tools\SharePoint2016\prerequisites\Synchronization.msi" /appfabric:"F:\Tools\SharePoint2016\prerequisites\WindowsServerAppFabricSetup_x64.exe" /kb3092423:"F:\Tools\SharePoint2016\prerequisites\AppFabric-KB3092423-x64-ENU.exe" /msipcclient:"F:\Tools\SharePoint2016\prerequisites\setup_msipc_x64.exe" /wcfdataservices56:"F:\Tools\SharePoint2016\prerequisites\WcfDataServices.exe" /odbc:"F:\Tools\SharePoint2016\prerequisites\msodbcsql.msi" /msvcrt11:"F:\Tools\SharePoint2016\prerequisites\vcredist_x64.exe" /msvcrt14:"F:\Tools\SharePoint2016\prerequisites\vc_redist.x64.exe" /dotnetfx:"F:\Tools\SharePoint2016\prerequisites\NDP46-KB3045557-x86-x64-AllOS-ENU.exe"
```

30.   This will restart the **SharePoint 2016 Products Preparation Tool**. When prompted, accept the default settings and wait till the installation of the prerequisites completes. Click **Finish**. 

  > **Note:** If PAM-SVR1 restarts again, repeat the steps 28 - 30.

31.   Start **Windows PowerShell ISE** as **Administrator**.
32.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-06.ps1):

```
Get-Service –Name wuauserv | Set-Service –StartupType Disabled
Restart-Computer -Force
```

33.   Log in back to the PAM-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

34.   Mount again the SharePoint 2016 installation media.
35.   Right-click **Start** and click **Command Prompt (Admin)**. When prompted, in the **User Account Control** dialog box, click **Yes**.
36.   From the **Administrator: Command Prompt**, switch to the drive where you mounted the SharePoint 2016 installation media and run the following to install SharePoint Foundation 2016:

```
.\setup.exe
```

37.   When prompted for the product key, type **NQGJR-63HC8-XCRQH-MYVCH-3J3QR**. Accept the license terms and proceed with the installation using the default settings.
38.   After the install completes, ensure that the checkbox next to the **Run the SharePoint Products Configuration Wizard now** is selected and click **Close**. 
39.   On the **Welcome to SharePoint Products** page of **SharePoint Products Configuration Wizard** click **Next** and click **Yes** to accept the restart or resets of Internet Information Services, SharePoint Administration Service, and SharePoint Timer Service services.
40.   On the **Connect to a server farm** page, click **Create a new server farm**. 
41.   On the **Specify Configuration Database Settings** page, specify **PAM-SVR1** as the database server for the configuration database, and **PRIV\\SharePoint** with the password **Pa55w.rd** as the database access account for SharePoint to use. 
42.   Specify **Pa55w.rd** as the farm security passphrase.  
43.   On the **Specify Server Role** page, click **Single-Server Farm**
44.   Accept the remaining settings with their default values and wait for the wizard to complete. 
45.   When the configuration wizard completes, take the note of the **Central Administration URL** and click **Finish**. This will open the Internet Explorer targeting the **Central Administration URL**. If prompted, authenticate by using **PRIV\\MIMAdmin** with the password **Pa55w.rd**. 
46.   If prompted, in the **Set up Internet Explorer 11** window, accept the default settings and click **OK**.
47.   In the **Internet Explorer** window, switch to the tab displaying the **Initial Farm Configuration Wizard** and, on the **Help Make SharePoint Better** page, click **No, I don’t wish to participate** and click **OK**.
48.   On the **Welcome page**, next to the **How do you want to configure your SharePoint farm** label, click **Start the Wizard**.
49.   On the **Service Applications and Services** page, select the option to use the existing managed account **PRIV\\SharePoint**, uncheck checkboxes next to any optional service applications, leaving only **Claims to Windows Token Service**, **Distributed Cache**, and **Microsoft SharePoint Foundation Workflow Timer Service** enabled, and click **Next**.

  > **Note:** If you receive **This page can’t be displayed** message, refresh the **Internet Explorer** window and repeat the step 49 again. 

51.   Once the **Create Site Collection** page appears, click **Skip** then **Finish**.
52.   To create a SharePoint web application that will host the MIM portal, click **Start**, expand the **Microsoft SharePoint 2016 Products**, right-click **SharePoint 2016 Management Shell**, click **More** and click **Run as administrator**. When prompted, in the **User Account Control** dialog box, click **Yes**.
53.   From the **Administrator: SharePoint 2016 Management Shell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-07.ps1):

```
$dbManagedAccount = Get-SPManagedAccount -Identity PRIV\SharePoint
New-SpWebApplication -Name 'MIM Portal' -ApplicationPool 'MIMAPPPool' -ApplicationPoolAccount $dbManagedAccount -AuthenticationMethod 'Kerberos' -Port 82 -URL http://PAM-SVR1.priv.adatum.com
```

54.   Next, from the **Administrator: SharePoint 2016 Management Shell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-08.ps1):

```
$t = Get-SPWebTemplate -CompatibilityLevel 15 -Identity "STS#1"
$w = Get-SPWebApplication http://PAM-SVR1.priv.adatum.com:82
New-SPSite -Url $w.Url -Template $t -OwnerAlias PRIV\MIMAdmin -CompatibilityLevel 15 -Name 'MIM Portal' -SecondaryOwnerAlias PRIV\BackupAdmin
$contentService = [Microsoft.SharePoint.Administration.SPWebService]::ContentService
$contentService.ViewStateOnServer = $false
$contentService.Update()
Get-SPTimerJob hourly-all-sptimerservice-health-analysis-job | Disable-SPTimerJob
```

55.   In the **Internet Explorer** window, navigate to http://pam-svr1.priv.adatum.com:82. If prompted, authenticate as **PRIV\\MIMAdmin** with the **Pa55w.rd** password.
56.   Verify that you can access the site. Next, in **Internet Explorer**, add http://pam-svr1.priv.adatum.com to the Local intranet security zone. 

  > **Note:** At this point, you are ready to install **MIM 2016 SP1 Service and Portal**, as described in https://docs.microsoft.com/en-us/microsoft-identity-manager/deploy-use/install-mim-service-portal 

57.   Close all open Internet Explorer windows.
58.   Start **File Explorer** and dismount any existing ISO images. Next, browse to the **F:\\Tools\\MIM2016SP1** folder, right click the ISO file and click **Mount**. Identify the drive letter of the mounted ISO file.
59.   From the **Administrator: Command Prompt** window, set the current directory to the root of the drive representing the mounted MIM 2016 SP1 installation media and run the following:

```
.\Service and Portal\setup.exe
```

60.   Step through the installation wizard. When prompted, accept the terms in the License Agreement and ensure that the option **I don’t want to join the program at this time** on the **MIM Customer Experience Improvement Program** page is not selected.
61.   On the **Custom Setup** page of the **Microsoft Identity Manager 2016 – Service and Portal** wizard, ensure that only the following components are selected:

  -   **MIM Service\\Privileged Access Management**
  -   **MIM Portal**

62.   On the **Configure Common Services – Configure** the MIM database connection page, ensure that the following entries are set and click **Next**.

  -   Database Server: **PAM-SVR1**
  -   Database Name: **FIMService**
  -   **Create a new database**

63.   On the **Configure Common Services – Configure mail server connection** page, set the email server to **adatum.com**, uncheck the **Use SSL** and **Mail Server is Exchange Server 2007 or Exchange Server 2010** checkboxes and click **Next**.
64.   On the **Configure Common Services – Configure server certificate** page, accept the default option **Generate a new self-issued certificate** and click **Next**.
65.   On the **Configure Common Services – Configure the MIM service account** page, ensure that the following entries are set and click **Next**.

  -   Service Account Name: **MIMService**
  -   Service Account Password: **Pa55w.rd**
  -   Service Account Domain: **PRIV**
  -   Service Email Account: **MIMService@priv.adatum.com**

66.   On the **Configure Common Services – Configure the Microsoft Identity Manager Service and Portal synchronization** page, ensure that the following entries are set and click Next.

  -   Synchronization Server: **PAM-SVR1**
  -   MIM Management Agent Account: **PRIV\\MIMMA**

67.   On the **Configure Common Services – Configure the Microsoft Identity Manager Service and Portal synchronization** page, note the warning message and click **Next**

  > **Note:** The warning message informs that the MIM synchronization service does not exist on PAM-SVR1. This can be ignored since the MIM synchronization service is not used in this scenario.

68.   On the **Configure MIM Service and Portal** page, set **MIM Service Server Address** to **PAM-SVR1** and click **Next**.
69.   On the **Configure MIM Service and Portal** page, set **SharePoint site collection URL** to http://pam-svr1.priv.adatum.com:82 and click **Next**.
70.   On the **Configure MIM Service and Portal** page, leave the **Registration Portal URL** text box blank and click **Next**.
71.   On the **Configure MIM Service and Portal Configure security changes configured by setup** page, select the checkbox to **Open ports 5725 and 5726 in firewall**, and the checkbox to **Grant all authenticated users access to the MIM portal site** and click **Next**.
72.   On the **Configure Privileged Access Management REST API** page, leave the **Host Name** text box empty, set **8086** as the port number, and click **Next**.
73.   On the **Configure Privileged Access Management REST API** page, specify the following settings and click **Next**.

  -   Application Pool Account Name: **SharePoint**
  -   Application Pool Account Password: **Pa55w.rd**
  -   Application Pool Account Domain: **PRIV**

74.   On the **Configure the PAM Component Service** page, specify the following settings and click **Next**.

  -   Service Account Name: **MIMComponent**
  -   Service Account Password: **Pa55w.rd**
  -   Service Account Domain: **PRIV**

75.   On the **Configure the Privileged Access Management Monitoring Service** page, specify the following settings and click **Next**.

  -   Service Account Name: **MIMMonitor**
  -   Service Account Password: **Pa55w.rd**
  -   Service Account Domain: **PRIV**

76.   On the **Enter Information for MIM Password Portals** page, leave the checkboxes **MIM Password Registration Portal will be installed on another host** and **MIM Password Reset Portal will be installed on another host** cleared and click **Next**
77.   On the **Install Identity Manager Service and Portal** page, click **Install**.
78.   Once the installation completes, on the **Completed the Microsoft Identity Manager Service and Portal Setup Wizard** page, click **Finish ** and then, when prompted whether to restart, click **Yes**.
 
  > **Note:** At this point you are ready to set up MIM Portal management policy rules.

79.   Log back on with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

80.   Start Internet Explorer and navigate to the MIM Portal at http://pam-svr1.priv.adatum.com:82/identitymanagement. If prompted, sign in as **PRIV\\MIMAdmin**
81.   In the **MIM Portal**, click **Management Policy Rules**.
82.   Search for the management policy rule **User management: Users can read attributes of their own**.
83.   Click this management policy rule, uncheck **Policy is disabled**, click **OK**, and then click **Submit**.
84.   To configure firewall to allow MIM-specific traffic, start **Windows Firewall with Advanced Security** (from the **Windows Administrative Tools** folder). 
85.   Click **Inbound Rules**. 
86.   Verify that the following two rules are enabled: 

  -   **Forefront Identity Manager Service (STS)**
  -   **Forefront Identity Manager Service (Webservice) **

87.   Create a new port rule named **Forefront Identity Manager Service (8086 8090)** applicable to the **domain**, **public**, and **private** profile that allows inbound connections to **TCP** ports **8086** and **8090**. 

  > **Note:** Next, you will install a sample MIM REST API application.

88.   Locate the archive file containing Identity Management sample code in the **F:\\Tools\\MIMSample** folder. 

  > **Note:** The archive is also available from https://github.com/Azure/identity-management-samples

89.   Unpack the contents of the folder **identity-management-samples-master\\Privileged-Access-Management-Portal\\src** into a new folder **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management Portal**.
90.   Start **Windows PowerShell** as **Administrator**. When prompted, in the **User Account Control** window, click **Yes**.
91.   From the **Administrator: Windows PowerShell** prompt, create new web site with a site name **MIM Privileged Access Management Example Portal**, physical path **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management Portal**, and port **8090 ** by running the following PowerShell cmdlet (F:\\Labfiles\\Scripts\\Ex1Task3-09.ps1):

```
New-WebSite -Name "MIM Privileged Access Management Example Portal" -Port 8090 -PhysicalPath "C:\Program Files\Microsoft Forefront Identity Manager\2010\Privileged Access Management Portal\"
```

92.   Set up the sample web application to redirect users to the MIM PAM REST API. To accomplish this, first open the open the file **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management REST API\\web.config** in Notepad by running the following from the **Administrator: Windows PowerShell** prompt:

```
Notepad “C:\Program Files\Microsoft Forefront Identity Manager\2010\Privileged Access Management REST API\web.config"
```

93.   In the section **<system.webServer>**, add the following lines following </handlers> (F:\\Labfiles\\Scripts\\Ex1Task3-10.txt):

```
<httpProtocol>
 <customHeaders>
  <add name="Access-Control-Allow-Credentials" value="true" />
  <add name="Access-Control-Allow-Headers" value="content-type" />
  <add name="Access-Control-Allow-Origin" value="http://pam-svr1:8090" />  
 </customHeaders>
</httpProtocol>
```

94.   Save and close the **web.config** file.
95.   Open **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management Portal\\js\\utils.js** in Notepad, verify that the value of **pamRespApiUrl** is set to http://pam-svr1.priv.adatum.com:8086/api/pamresources/, and close the file.
96.   Restart IIS by running the following from the **Administrator: Windows PowerShell** prompt:

```
iisreset
```

97.   To verify that the user can authenticate to the REST API, start **Internet Explorer** and navigate to http://pam-svr1.priv.adatum.com:8086/api/pamresources/pamroles/ . If prompted, authenticate as **PRIV\\MIMAdmin** with **Pa55w.rd** as the password. Ensure that you are prompted to open or save **pamroles.json**. 


#### Task 4: Prepare LON-CL1

1.   Sign in to the LON-CL1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Click **Start**, in the **Run** text box type **cmd**, and click **OK**.
3.   From the Command Prompt window, change the current directory to the **F:\\Tools\\MIM2016SP1\\Add-ins and extensions\\x64** folder and run:

```
setup.exe
```

4.   Step through the installation wizard. When prompted, accept the License Agreement terms and ensure that the option **I don’t want to join the program at this time on the MIM Customer Experience Improvement Program** is selected.
5.   On the **Custom Setup** page of the installation wizard, select to install the **PAM Client** but deselect the **MIM Add-in for Outlook** and the **MIM Password and Authentication Extensions** and click **Next**.
6.   On the **Configure MIM PAM Service Address** of the installation wizard, set the **PAM Server Address** to **pam-svr1.priv.adatum.com** and accept the default Port value.
7.   After the installation completes, restart LON-CL1.

#### Task 5: Establish trust between the ADATUM and PRIV Active Directory forests

1.   While logged on to the PAM-SVR1 lab virtual machine as PRIV\\MIMAdmin, from **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task5-01.ps1):

```
$ca = Get-Credential
New-PAMTrust -SourceForest "adatum.com" -Credentials $ca
```

When prompted, type in credentials of the member of the Domain Admins group in the ADATUM domain (**ADATUM\\Administrator** with the password **Pa55w.rd**)

2.   Switch to the LON-DC1 lab virtual machine where you are signed on as ADATUM\\Administrator
3.   On LON-DC1, switch to the **Group Policy Management** console.
4.   In the **Group Policy Management** console, navigate to the **Default Domain Controllers Policy** GPO. 
5.   Right-click the **Default Domain Controllers Policy** GPO and click **Edit**. 
6.   In the **Group Policy Management Editor** window, under the **Default Domain Controllers Policy** tree, navigate to **Computer Configuration > Policies > Administrative Templates > System > Remote Procedure Call**.
7.   In the details pane, right click **Enable RPC Endpoint Mapper Client Authentication** and click **Properties**. Click **Disabled** and click **OK**. 

  > **Note:** This is necessary to account for the behavior described in https://blogs.technet.microsoft.com/the_9z_by_chris_davis/2016/11/22/dns-isnt-always-the-cause-of-selected-objects-in-the-following-domains-are-not-available/ 

8.   Switch to the Command Prompt window.
9.   From the Command Prompt window, run the following:

```
gpupdate /force /target:computer
```

10.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task5-02.cmd):

```
netdom trust adatum.com /domain:priv.adatum.com /enablesidhistory:yes /usero:ADATUM\administrator /passwordo:Pa55w.rd
netdom trust adatum.com /domain:priv.adatum.com /quarantine:no /userd:PRIV\administrator /passwordd:Pa55w.rd
netdom trust adatum.com /domain:priv.adatum.com /enablepimtrust:yes /usero:ADATUM\administrator /passwordo:Pa55w.rd
```

11.   Start **Active Directory Users and Computers**. 
12.   Right click on the domain **adatum.com** and click **Delegate Control**. 
13.   On the **Selected Users and Groups** tab, click **Add**. 
14.   In the **Select Users, Computers, or Groups** dialog box, click **Locations** and change the location to **priv.adatum.com**. In the list of object names to select, type **Domain Admins;MIMMonitor** and click **Check Names**. When prompted, authenticate as **PRIV\\Administrator** with the password **Pa55w.rd**. 
15.   In the **Users and Groups** dialog box, click **Next**.
16.   On the **Tasks to Delegate** page, in the list of common tasks, select **Read all user information**, and complete the **Delegation of Control Wizard**. 

> **Result**: After completing this exercise, you have implemented infrastructure necessary to support PAM and JIT in the bastion forest scenario.

## Exercise 2: Testing PAM and JIT

#### Task 1: Create privileged accounts

1.   Switch to the PAM-SVR1 lab virtual machine and ensure that you are logged on with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**.
3.   From the **Administrator: Windows PowerShell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task1-01.ps1):

```
$su = New-PAMUser –SourceDomain adatum.com –SourceAccountName CorpAdmin01
$sp = ConvertTo-SecureString –AsPlaintext 'Pa55w.rd' –Force
Set-ADAccountPassword –Identity PRIV.CorpAdmin01 –NewPassword $sp -Reset
Set-ADUser –Identity PRIV.CorpAdmin01 –Enabled 1
```

4.   From the **Administrator: Windows PowerShell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task1-02.ps1):

```
$casp = ConvertTo-SecureString –AsPlaintext 'Pa55w.rd' –Force
$ca = New-Object –TypeName System.Management.Automation.PSCredential –ArgumentList ‘ADATUM\Administrator’,$casp
$pg = New-PAMGroup –SourceGroupName "CorpAdmins" –SourceDomain adatum.com –SourceDC LON-DC1.adatum.com –Credentials $ca
$pr = New-PAMRole –DisplayName "CorpAdmins" –Privileges $pg –Candidates $su
```

  > **Note:** This script copies the group ADATUM\\CorpAdmins with its group membership to the PRIV domain. Note that the group is not directly visible in the Active Directory Users and Computers console (unlike the PAM user, which appears in the PAM Objects Organizational Unit), since it is stored in the Configuration partition of Active Directory (you can actually view it in the Active Directory Sites and Services if you display the Services node). However, you can display its properties by using the Get-PAMGroup cmdlet.

#### Task 2: Elevate access via PAM

1.   Switch to LON-DC1 and start **Windows PowerShell** as **Administrator**.
2.   From the **Administrator: Windows PowerShell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task2-01.ps1):

```
Remove-ADGroupMember -Identity 'CorpAdmins' -Members 'CorpAdmin01' –Confirm:$false
```

3.   Sign in to the LON-CL1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\CorpAdmin01**
  -   PASSWORD: **Pa55w.rd**

4.   Click **Start**, in the **Start** menu, expand the **Windows System** folder, right-click **Command Prompt**, click **More**, and then click **Run as Administrator**. When prompted, in the **User Account Control** dialog box, click **Yes**.
5.   From the **Administrator: Command Prompt** window, run the following:

```
dir \\LON-DC1.adatum.com\corpfs
```

  > **Note:** Ensure that the command triggers the **Access is denied** message. This is expected since ADATUM\\CorpAdmin01 is no longer a member of the ADATUM\\CorpAdmins group

6.   From the Command Prompt window, run the following:

```
runas /user:PRIV.CorpAdmin01@priv.adatum.com powershell
```

7.   When prompted, authenticate by providing the password **Pa55w.rd** of the **PRIV\\PRIV.CorpAdmin01** user account. This will automatically open a new Windows PowerShell window.
8.   From the Windows PowerShell prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task2-02.ps1):

```
$r = Get-PAMRoleForRequest | Where-Object { $_.DisplayName –eq "CorpAdmins" }
New-PAMRequest –Role $r
```

  > **Note:** This command generates a request for assignment of the CorpAdmins PAM role. The output of the command displays the settings of the CorpAdmins role. Note the value of the TTL property of the role, which determines the duration of access associated with the role through its domain groups (CorpAdmins in our case).

9.   From the Windows PowerShell prompt, run the following:

```
klist purge
```

  > **Note:** This command purges tickets in the Kerberos ticket cache to eliminate any potential impact they might have on privileges of CorpAdmin01.

10.   Close the Windows PowerShell window.
11.   From the Command Prompt window, run again the following:

```
runas /user:PRIV.CorpAdmin01@priv.adatum.com powershell
```

12.   When prompted, authenticate by providing the password **Pa55w.rd** of the **PRIV\\PRIV.CorpAdmin01** user account. This will automatically open a new Windows PowerShell window.
13.   From the Windows PowerShell prompt, run the following: 

```
whoami /groups
dir \\LON-DC1.adatum.com\corpfs
```

  > **Note:** Ensure that this time there is no **Access is denied** message. This is expected since, as the output of whoami /groups indicate, you are operating now as a member of the ADATUM\\CorpAdmins group

14.   Switch to the PAM-SVR1 lab virtual machine.
15.   From the **Administrator: Windows PowerShell ISE** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task2-03.ps1):

```
$user = Get-PAMUser -SourceAccountName CorpAdmin01 -SourceDomain ADATUM
Get-PAMRequest -User $user
```

  > **Note:** The cmdlet lists all requests (active, closed, and expired) submitted by ADATUM\\CorpAdmin01 user (via its PRIV\\PRIV.CorpAdmin01 security principal (to list only the active ones, you can simply add the –Active switch). Note the expiration time of the request. 

16.   Switch to the PAM-DC1 lab virtual machine.
17.   Start **Active Directory Users and Computers**. 
18.   Navigate to the **PAM objects** organizational unit and double-click **PRIV.CorpAdmin01** to display its **Properties** dialog box. 
19.   In the **Properties** dialog box, click the **Member Of** tab. 

  > **Note:** Verify that PRIV.CorpAdmin01 is currently a member of the ADATUM\\CorpAdmins shadow security group. The user will be automatically removed from the group after 1 hour.

> **Result**: After completing this exercise, you have created the PAM user, group, and role in the PRIV forest and tested their functionality from the ADATUM forest.

©2016 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply.  All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant.  This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  