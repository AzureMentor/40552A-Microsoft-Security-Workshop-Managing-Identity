# Lab Answer Key:  Microsoft Security Workshop: Managing Identity
# Lab: AD Privileged Access Management (PAM) and Just In Time Administration (JIT)

### Scenario

The lab environment consists of the following single-domain forests:
-   adatum.com – corporate forest containing user accounts, including privileged accounts that need to be protected
-   priv.adatum.com – bastion forest containing PAM users, groups, and roles that will protect privileged accounts in the account forest
Both single domain forests are operating at Windows Server 2016 domain and forest functional level. 

  > **Note:** It is possible to implement this scenario with the account forest operating on Windows Server 2012 R2 domain and forest functional level.

  > **Note:** Windows Server 2016 introduces a new type of forest trust, with support for a new type of security principal (msDS-ShadowPrincipal). Each shadow security principal in the bastion forest has its security identifier (SID) matching the SID of the corresponding security principal in the forest containing privileged user accounts that need to be protected. In addition, the Windows Server 2016 Active Directory forest functional level makes it possible to implement time-limited group membership, which duration you can adjust by modifying the maximum lifetime for Kerberos user tickets of KDC (configurable via Default Domain Controllers GPO in the bastion forest)

  > **Note:** The lab focuses on implementation of PAM and JIT. However, keep in mind that maximizing security in your AD environment should include other AD-based security mechanisms. In particular, you might want to take advantage of the Protected Users as well as Authentication Policies and Silos in order to ensure that highly privileged accounts are prevented from accessing less secure resources. For example, you could: 
-   Prevent logons of Domain admins (tier 0) to enterprise servers (tier 1) and standard user workstations (tier 2).
-   Prevent logons of Server administrators (tier 1) to standard user workstations (tier 2).
In addition, you should harden the Active Directory environment – especially the one serving the bastion role by following the guidelines described in https://docs.microsoft.com/en-us/microsoft-identity-manager/pam/planning-bastion-environment
This lab takes you through an implementation of PAM and JIT that leverages Windows Server 2016 AD features. If you are using for this purpose Windows Server 2012 R2 domain controllers, refer to https://docs.microsoft.com/en-us/microsoft-identity-manager/pam/configuring-mim-environment-for-pam for the implementation steps. Using Windows Server 2016 AD (including the corresponding domain functional level) eliminates some requirements that must be satisfied when working with Windows Server 2012 R2. For more information, refer to https://docs.microsoft.com/en-us/microsoft-identity-manager/pam/deploy-pam-with-windows-server-2016 . 

  > **Note:** For the simplicity sake, the lab implements the scenario that relies on the auto-approval capabilities of the MIM 2016 SP1. You will use both the MIM Portal and MIMPAM PowerShell module to interact with MIM 2016 SP1 deployment. This will result in the following user experience:
1. ADATUM\CorpAdmin01 logs on to LON-CL1 and submits a role request via PowerShell. The request is for the PAM role CORPAdmins which grants access to a file share for members of ADATUM\CORPAdmins group.  Note that the ADATUM\CORPAdmins group remains empty throughout the entire process.
2. The MIM Service grants elevation and adds the PRIV\PRIV.CorpAdmin01 PAM user account (shadow security principal) to the PRIV\ADATUM.CORPAdmins shadow security group. The SIDHistory attribute of the shadow security group contains the SID of ADATUM\CORPAdmins.
3. ADATUM\CorpAdmin01 authenticates as PRIV\PRIV.CorpAdmin01 and accesses the file share that requires membership in ADATUM\CORPAdmins. 
4. After the expiration of the Kerberos user ticket (1 hour by default), the service account running the PAM Component Service removes PRIV\PRIV.CorpAdmin01 from the PRIV\ADATUM.CORPAdmins group.

### Objectives
  
After completing this lab, you should be able to:

-   Implement PAM infrastructure
-   Implement and verify functionality of PAM users, groups, and roles

### Lab setup
  
Estimated Time: 150 minutes

The lab consists of the following virtual machines: 
-   LON-DC1 – a Windows Server 2016-based domain controller in the adatum.com single domain forest (Server with Desktop Experience) 
-   LON-CL1 – a Windows 10 Enterprise-based domain member in the adatum.com domain
-   PAM-DC1 – a Windows Server 2016-based domain controller in the priv.adatum.com single domain forest (Server with Desktop Experience)
-   PAM-SVR1 – a Windows Server 2016-based domain member server in the priv.adatum.com domain (Server with Desktop Experience). In the course of the lab, you will install on this server SQL Server 2017, SharePoint 2016, and MIM 2016. The server will host the MIM 2016 SP1 implementation, including MIM PAM REST API, MIM Portal, and MIM Service.  
You will use both the MIMPAM PowerShell module to interact with PAM. 

Installation media for the following products are available in the F:\Tools folder on PAM-SVR1.
-   SQL Server 2017 
-   SharePoint 2016
-   Microsoft Identity Manager 2016 SP1 


## Exercise 1: Implement PAM and JIT Infrastructure

The main task for this exercise are:

1.   Prepare ADATUM Active Directory
2.   Prepare PRIV Active Directory
3.   Prepare PAM-SVR1
4.   Prepare LON-CL1
5.   Establish trust between the ADATUM and PRIV Active Directory forests

#### Task 1: Prepare ADATUM Active Directory

In this task, you will:
-   Create a privileged user and a corresponding group in the ADATUM AD domain 
-   Implement PAM and JIT prerequisites and best practices in the ADATUM AD domain, including cross forest DNS name resolution and GPO-based auditing
-   Create a file share and restrict its access to the privileged group
-   Add the privileged user to local administrators on the CORPSRV (this is necessary for the lab purposes)

1.   Sign in to the LON-DC1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**. 
3.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task1-01.ps1):

```
New-ADGroup –Name CorpAdmins –GroupCategory Security –GroupScope Global –SamAccountName CorpAdmins
New-ADUser –SamAccountName CorpAdmin01 –Name CorpAdmin01
Add-ADGroupMember –Identity CorpAdmins –Members CorpAdmin01
$password = ConvertTo-SecureString 'Pa55w.rd' –AsPlainText –Force
Set-ADAccountPassword –Identity CorpAdmin01 –NewPassword $password
Set-ADUser –Identity CorpAdmin01 –Enabled 1 -DisplayName 'CorpAdmin 01'
```

  > **Note:** The script creates a new user named CorpAdmin01 and a domain global group named CorpAdmins. It also adds the CorpAdmin01 user to the CorpAdmins group.

  > **Note:** For simplicity sake and in order to avoid issues due to typos, all passwords in this lab are set to Pa55w.rd. Obviously outside of a lab environment, this is not a recommended practice.


4.   Start **Group Policy Management**.
5.   From the Group Policy Management console, edit the **Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Audit Policy** settings in the **Default Domain Controllers Policy** GPO:

  -   Audit account management: enable both **Success** and **Failure** auditing
  -   Audit directory service access: enable both **Success** and **Failure** auditing

6.   Force the update of the group policy. 
7.   From the **Administrator: Windows PowerShell ISE** window, run the following (where `172.16.0.200` is the IP address of **PAM-DC1**) (F:\\Labfiles\\Scripts\\Ex1Task1-02.ps1):

```
Add-DnsServerZoneDelegation –Name "adatum.com" -ChildZoneName “priv” -NameServer “PAM-DC1.priv.adatum.com” -IPAddress “172.16.0.200”
```

  > **Note:** The cmdlet creates a delegated zone that facilitates the name resolution for the priv.adatum.com namespace by pointing to the PAM-DC1 as the resolver.

8.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task1-03.ps1):

```
New-Item -Path c:\corpfs -ItemType directory
New-SMBShare –Name corpfs –Path 'c:\corpfs' –ChangeAccess 'ADATUM\CorpAdmins'
$acl = Get-Acl c:\corpfs
$car = New-Object System.Security.AccessControl.FileSystemAccessRule( "ADATUM\CorpAdmins", "FullControl", "Allow")
$acl.SetAccessRule($car)
Set-Acl c:\corpfs $acl
```

  > **Note:** The script creates a file share that you will use when testing PAM functionality later in this lab.

9.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task1-04.ps1):

```
Invoke-Command -ComputerName lon-cl1 -ScriptBlock {Add-LocalGroupMember -Group Administrators -Member 'ADATUM\CorpAdmin01'}
```

  > **Note:** The script adds the ADATUM\CorpAdmin01 to the local Administrators group on LON-CL1. This will allow you to use this account to test PAM and JIT in the second exercise of this lab.


#### Task 2: Prepare PRIV Active Directory

In this task, you will:
-   Create user and service accounts that will be used by your MIM implementation
-   Implement PAM and JIT prerequisites and best practices in the PRIV Active Directory domain, including cross forest DNS name resolution, GPO-based auditing, Kerberos maximum lifetime for user tickets policy, user domain-level rights assignments for MIM user and service accounts, AD permissions for MIM user and service accounts, as well as service principal names (SPNs) for MIM and PAM components. 

1.   Sign in to the PAM-DC1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**
3.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-01.ps1):

```
$password = ConvertTo-SecureString "Pa55w.rd" –AsPlainText –Force
New-ADUser –SamAccountName MIMMA –Name MIMMA
Set-ADAccountPassword –Identity MIMMA –NewPassword $password
Set-ADUser –Identity MIMMA –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMMonitor –Name MIMMonitor -DisplayName MIMMonitor
Set-ADAccountPassword –Identity MIMMonitor –NewPassword $password
Set-ADUser –Identity MIMMonitor –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMComponent –Name MIMComponent -DisplayName MIMComponent
Set-ADAccountPassword –Identity MIMComponent –NewPassword $password
Set-ADUser –Identity MIMComponent –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMSync –Name MIMSync
Set-ADAccountPassword –Identity MIMSync –NewPassword $password
Set-ADUser –Identity MIMSync –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName MIMService –Name MIMService
Set-ADAccountPassword –Identity MIMService –NewPassword $password
Set-ADUser –Identity MIMService –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName SharePoint –Name SharePoint
Set-ADAccountPassword –Identity SharePoint –NewPassword $password
Set-ADUser –Identity SharePoint –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName SqlServer –Name SqlServer
Set-ADAccountPassword –Identity SqlServer –NewPassword $password
Set-ADUser –Identity SqlServer –Enabled 1 –PasswordNeverExpires 1
New-ADUser –SamAccountName BackupAdmin –name BackupAdmin
Set-ADAccountPassword –Identity BackupAdmin –NewPassword $password
Set-ADUser –Identity BackupAdmin –Enabled 1 -PasswordNeverExpires 1
New-ADUser -SamAccountName MIMAdmin -Name MIMAdmin
Set-ADAccountPassword –Identity MIMAdmin -NewPassword $password
Set-ADUser -Identity MIMAdmin -Enabled 1 -PasswordNeverExpires 1
Add-ADGroupMember "Domain Admins" SharePoint
Add-ADGroupMember "Domain Admins" MIMService
```

  > **Note:** The scripts creates a number of user accounts that will be used to configure the MIM installation later in this lab, including MIMMA, MIMMonitor, MIMComponent, MIMSync, MimService, SharePoint, SqlServer, BackupAdmin, and MIMAdmin

4.   Start **Group Policy Management**.
5.   From the **Group Policy Management** edit the following settings of the **Default Domain Controllers Policy** GPO: 

  -   Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Audit Policy > Audit account management: enable both **Success** and **Failure** auditing
  -   Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Kerberos Policy > Maximum lifetime for user ticket: set the number of hours to **1**

  > **Note:** This automatically configures the following values:
  -   Maximum lifetime for service ticket: **10 minutes**
  -   Maximum lifetime for user ticket renewal: **7 days**

6.   From the **Group Policy Management** edit the following settings of the **Default Domain Policy** GPO: 

  -   Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > User Rights Assignment: 
     -   **Deny log on as a batch job**: **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent**
     -   **Deny log on through Remote Desktop Services**: **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent**

7.   Force the update of the group policy. 
8.   From **Administrator: Windows PowerShell ISE**, run the following (where `<IP address of LON-DC1>` is the IP address of **LON-DC1**) (F:\\Labfiles\\Scripts\\Ex1Task2-02.ps1):

```
Add-DnsServerConditionalForwarderZone –Name "adatum.com" –MasterServers 172.16.0.100
```

  > **Note:** The cmdlet creates a conditional forwarder that facilitates the name resolution for the adatum.com namespace by pointing to the LON-DC1 as the resolver.

9.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-03.cmd):

```
setspn -S http/pam-svr1.priv.adatum.com PRIV\SharePoint
setspn -S http/pam-svr1 PRIV\SharePoint
setspn -S FIMService/pam-svr1.priv.adatum.com PRIV\MIMService
setspn -S FIMService/pam-svr1 PRIV\MIMService
```

  > **Note:** These commands register Service Principal Names which are necessary to facilitate Kerberos authentication for MIM-related services.

10.   From the **Active Directory Users and Computers** console, delegate the **Create, delete, and manage user accounts** and **Modify the membership of a group** to **PRIV\\mimcomponent**, **PRIV\\mimmonitor**, and **PRIV\mimservice** on the domain level.
11.   From the **Active Directory Users and Computers** console, delegate the following general permissions to **PRIV\\MIMAdmin** with the **This folder, existing objects in this folder, and creation of new objects in this folder** option enabled on the domain level:

  -   **Read**
  -   **Write**
  -   **Create all Child Objects** 
  -   **Delete all Child Objects** 
  -   **Read All Properties** 
  -   **Write All Properties** 
  -   **Migrate SID History**

11.   From the **Active Directory Users and Computers** console, delegate the following general permissions to **PRIV\\MIMAdmin** with the **Only the following objects in this folder** option set to the **User** objects setting on the domain level:

  -   **Change password**
  -   **Reset password**

12.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-04.cmd):

```
dsacls "cn=adminsdholder,cn=system,dc=priv,dc=adatum,dc=com" /G PRIV\mimservice:WP;"member" 
dsacls "cn=adminsdholder,cn=system,dc=priv,dc=adatum,dc=com" /G PRIV\mimcomponent:WP;"member"
```

  > **Note:** These commands assign permissions to the MIM service and component accounts necessary to ensure that these accounts can manage membership of groups protected by the Admin SD Holder mechanism. 

13.   From **Administrator: Windows PowerShell ISE**, run the following (confirm when prompted whether you want to perform this action) (F:\\Labfiles\\Scripts\\Ex1Task2-05.ps1):

```
$of = Get-ADOptionalFeature –Filter "name -eq 'privileged access management feature'"
Enable-ADOptionalFeature $of -Scope ForestOrConfigurationSet -Target "priv.adatum.com"
```

  > **Note:** This script enables the Privileged Management features in Windows Server 2016 Active Directory. Note that this operation is irreversible

14.   Authorize the MIM administrators and MIM Service account to create and update shadow principals by using the following steps:
15.   Start **ADSIEdit**.
16.   In **ADSI Edit**, connect to the **Configuration** naming context
17.   Navigate to **CN=Configuration, CN=Services**.
18.   Modify permissions of the **CN=Shadow Principal Configuration** object by granting the **PRIV\\MIMService** and **PRIV\\MIMAdmin** user accounts that will be creating additional PAM groups the **Write**, **Create all child objects**, and **Delete all child objects** permissions that apply to **This object and all descendant objects**.
19.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task2-06.cmd):

```
dsacls "CN=AuthN Policies,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:RPWPRCWD;;msDS-AuthNPolicy /i:s
dsacls "CN=AuthN Policies,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:CCDC;msDS-AuthNPolicy
dsacls "CN=AuthN Silos,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:RPWPRCWD;;msDS-AuthNPolicySilo /i:s
dsacls "CN=AuthN Silos,CN=AuthN Policy Configuration,CN=Services,CN=configuration,DC=priv,DC=adatum,DC=com" /g PRIV\mimadmin:CCDC;msDS-AuthNPolicySilo
```

  > **Note:** These commands authorize the PRIV\MIMAdmin account to create and update authentication policy.

#### Task 3: Prepare PAM-SVR1

In this task, you will perform the following actions on PAM-SVR1:
-   Install and configure the IIS and Application roles 
-   Configure user rights assignments for MIM user and service accounts
-   Install SQL Server 2017
-   Install and configure SharePoint 2016 

1.   Log in to the PAM-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**.
3.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-01.ps1):

```
Install-WindowsFeature Web-WebServer,Net-Framework-Features,rsat-ad-powershell,Web-Mgmt-Tools, Windows-Identity-Foundation,Server-Media-Foundation,Xps-Viewer -IncludeAllSubFeature -Source F:\Tools\WS2016\sources\sxs -Restart
```

  > **Note:**  The cmdlet installs the server roles, role services, and features required by the PAM deployment. If the restart is required, the cmdlet will automatically trigger it once the installation is completed. 

4.   Use the **Local Security Policy** console to modify the following user rights assignments:

  -   Log on as a service:**PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\SharePoint; PRIV\\MIMComponent; PRIV\\SqlServer**
  -   Deny access to this computer from the network: **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent**
  -   Deny log on locally: **PRIV\\MIMMonitor; PRIV\\MIMService; PRIV\\MIMComponent** 

5.   Add PRIV\\MIMAdmin and PRIV\\SharePoint accounts to the local Administrators group
6.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-02.cmd):

```
iisreset /STOP
C:\Windows\System32\inetsrv\appcmd.exe unlock config /section:windowsAuthentication -commit:apphost 
iisreset /START
```

  > **Note:**  These commands modify the IIS configuration to allow its applications to use Windows authentication. 

7.   Log off and log back on with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

8.   Mount **F:\\Tools\\SQLServer2017\\SQLServer2017-x64-ENU.ISO** file. Identify the drive assigned to the mounted ISO file.
9.   Start **Command Prompt** as Administrator. 
10.   From the **Administrator: Command Prompt** window, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-03.cmd):

```
.\setup.exe /Q /IACCEPTSQLSERVERLICENSETERMS /ACTION=install /FEATURES=SQL /INSTANCENAME=MSSQLSERVER /SQLSVCACCOUNT="PRIV\SqlServer" /SQLSVCPASSWORD=”Pa55w.rd” /AGTSVCSTARTUPTYPE=Automatic /AGTSVCACCOUNT="NT AUTHORITY\Network Service" /SQLSYSADMINACCOUNTS="PRIV\MIMAdmin"
```

  > **Note:**  This command runs unattended installation of SQL Server. Wait for the installation to complete. 

11.   Next, start **Windows PowerShell ISE** as **Administrator** and, from **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-04.ps1):

```
Get-Service –Name wuauserv | Set-Service –StartupType Automatic 
Get-Service –Name wuauserv | Start-Service
```

  > **Note:**  The cmdlet temporarily enables and starts the Windows Update service. This service is intentionally disabled in the lab environment in order to eliminate the impact of updates installing on lab VMs.

12.   Mount the **F:\\Tools\\SharePoint2016\\officeserver.img** file. Identify the drive letter assigned to the mounted ISO file. 	
13.   Next, you will install SharePoint 2016. From the **Administrator: Command Prompt**, switch to the drive where you mounted the SharePoint 2016 installation media and run the following (F:\\Labfiles\\Scripts\\Ex1Task3-05.cmd):

```
.\prerequisiteinstaller.exe /sqlncli:"F:\Tools\SharePoint2016\prerequisites\sqlncli.msi" /idfx11:"F:\Tools\SharePoint2016\prerequisites\MicrosoftIdentityExtensions-64.msi" /sync:"F:\Tools\SharePoint2016\prerequisites\Synchronization.msi" /appfabric:"F:\Tools\SharePoint2016\prerequisites\WindowsServerAppFabricSetup_x64.exe" /kb3092423:"F:\Tools\SharePoint2016\prerequisites\AppFabric-KB3092423-x64-ENU.exe" /msipcclient:"F:\Tools\SharePoint2016\prerequisites\setup_msipc_x64.exe" /wcfdataservices56:"F:\Tools\SharePoint2016\prerequisites\WcfDataServices.exe" /odbc:"F:\Tools\SharePoint2016\prerequisites\msodbcsql.msi" /msvcrt11:"F:\Tools\SharePoint2016\prerequisites\vcredist_x64.exe" /msvcrt14:"F:\Tools\SharePoint2016\prerequisites\vc_redist.x64.exe" /dotnetfx:"F:\Tools\SharePoint2016\prerequisites\NDP46-KB3045557-x86-x64-AllOS-ENU.exe"
```

14.   This will start the **SharePoint 2016 Products Preparation Tool**. When prompted, accept the default settings and wait till the installation of the prerequisites completes. 
15.   Click **Finish** to restart PAM-SVR1.
16.   Once PAM-SVR1 is back online, log in back to the PAM-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

17.   Mount again the SharePoint 2016 installation media, start **Command Prompt** as Administrator, switch to the drive where you mounted the SharePoint 2016 installation media and re-run the following (F:\\Labfiles\\Scripts\\Ex1Task3-05.cmd):

```
.\prerequisiteinstaller.exe /sqlncli:"F:\Tools\SharePoint2016\prerequisites\sqlncli.msi" /idfx11:"F:\Tools\SharePoint2016\prerequisites\MicrosoftIdentityExtensions-64.msi" /sync:"F:\Tools\SharePoint2016\prerequisites\Synchronization.msi" /appfabric:"F:\Tools\SharePoint2016\prerequisites\WindowsServerAppFabricSetup_x64.exe" /kb3092423:"F:\Tools\SharePoint2016\prerequisites\AppFabric-KB3092423-x64-ENU.exe" /msipcclient:"F:\Tools\SharePoint2016\prerequisites\setup_msipc_x64.exe" /wcfdataservices56:"F:\Tools\SharePoint2016\prerequisites\WcfDataServices.exe" /odbc:"F:\Tools\SharePoint2016\prerequisites\msodbcsql.msi" /msvcrt11:"F:\Tools\SharePoint2016\prerequisites\vcredist_x64.exe" /msvcrt14:"F:\Tools\SharePoint2016\prerequisites\vc_redist.x64.exe" /dotnetfx:"F:\Tools\SharePoint2016\prerequisites\NDP46-KB3045557-x86-x64-AllOS-ENU.exe"
```

18.   This will restart the **SharePoint 2016 Products Preparation Tool**. When prompted, accept the default settings and wait till the installation of the prerequisites completes. Click **Finish**. 

  > **Note:** If PAM-SVR1 restarts again, repeat the steps 17-18.

19.   Start **Windows PowerShell ISE** as **Administrator**.
20.   From **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-06.ps1):

```
Get-Service –Name wuauserv | Set-Service –StartupType Disabled
Restart-Computer -Force
```

  > **Note:** The cmdlets disable the Windows Update service and restart the VM.

21.   Log in back to the PAM-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

22.   Mount again the SharePoint 2016 installation media.
23.   Start **Command Prompt** as Administrator. 
24.   From the **Administrator: Command Prompt**, switch to the drive where you mounted the SharePoint 2016 installation media and run the following to install SharePoint Foundation 2016:

```
.\setup.exe
```

25.   When prompted for the product key, type **NQGJR-63HC8-XCRQH-MYVCH-3J3QR**. Accept the license terms and proceed with the installation using the default settings.
26.   After the install completes, start the **SharePoint Products Configuration Wizard**. 
27.   Use the wizard to create a new single server farm with the following settings (accept all remaining default values):

  -   Configuration Database server: **PAM-SVR1**
  -   SharePoint database access account name: **PRIV\\SharePoint**
  -   SharePoint database access account password: **Pa55w.rd**
  -   Farm security passphrase: **Pa55w.rd**

  > **Note:** In a production environment, you should choose Kerberos rather than NTLM when configuring SharePoint Central Administrator Web Application. In this lab, we use the default for simplicity sake, in order not to extend the duration of this already fairly complex and lengthy lab. We will actually use Kerberos authentication method for the SharePoint Web Application hosting the MIM portal. For information regarding using Kerberos for SharePoint Central Administrator Web Application, refer to https://social.technet.microsoft.com/wiki/contents/articles/36411.share-point-20132016-web-application-configuring-kerberos-authentication.aspx


28.   When the configuration wizard completes, take the note of the **Central Administration URL** and click **Finish**. This will open the Internet Explorer targeting the **Central Administration URL**. If prompted, authenticate by using **PRIV\\MIMAdmin** with the password **Pa55w.rd**. 
29.   From the **Internet Explorer** window, run **Initial Farm Configuration Wizard** 
30.   On the **Service Applications and Services** page, select the option to use the existing managed account **PRIV\\SharePoint**, uncheck checkboxes next to any optional service applications, leaving only **Claims to Windows Token Service**, **Distributed Cache**, and **Microsoft SharePoint Foundation Workflow Timer Service** enabled, and click **Next**.
31.   Once the **Create Site Collection** page appears, click **Skip** then **Finish**.
32.   Create a SharePoint web application that will host the MIM portal by runnning the following from the **SharePoint 2016 Management Shell** (F:\\Labfiles\\Scripts\\Ex1Task3-07.ps1):

```
$dbManagedAccount = Get-SPManagedAccount -Identity PRIV\SharePoint
New-SpWebApplication -Name 'MIM Portal' -ApplicationPool 'MIMAPPPool' -ApplicationPoolAccount $dbManagedAccount -AuthenticationMethod 'Kerberos' -Port 82 -URL http://PAM-SVR1.priv.adatum.com
```

  > **Note:** The cmdlet will trigger a warning message informing you that Windows Classic authentication method that is being used is deprecated in the current product release. We will use the Windows Classic authentication method for the sake of simplicity. If you want to learn about implementing Claims authentication, refer to https://technet.microsoft.com/en-us/library/ee806885.aspx Once the cmdlet execution completes, its output will include the URL of the new portal (http://pam-svr1.priv.adatum.com:82/ )

33.   Next, from the **Administrator: SharePoint 2016 Management Shell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex1Task3-08.ps1):

```
$t = Get-SPWebTemplate -CompatibilityLevel 15 -Identity "STS#1"
$w = Get-SPWebApplication http://PAM-SVR1.priv.adatum.com:82
New-SPSite -Url $w.Url -Template $t -OwnerAlias PRIV\MIMAdmin -CompatibilityLevel 15 -Name 'MIM Portal' -SecondaryOwnerAlias PRIV\BackupAdmin
$contentService = [Microsoft.SharePoint.Administration.SPWebService]::ContentService
$contentService.ViewStateOnServer = $false
$contentService.Update()
Get-SPTimerJob hourly-all-sptimerservice-health-analysis-job | Disable-SPTimerJob
```

  > **Note:** This sequence of commands sets the compatibility level on the target web application and disables the SharePoint task "Health Analysis Job (Hourly, Microsoft SharePoint Foundation Timer, All Servers)" 

34.   In the **Internet Explorer** window, navigate to http://pam-svr1.priv.adatum.com:82. If prompted, authenticate as **PRIV\\MIMAdmin** with the **Pa55w.rd** password.
35.   Verify that you can access the site. Next, in **Internet Explorer**, add http://pam-svr1.priv.adatum.com to the Local intranet security zone. 

  > **Note:** At this point, you are ready to install **MIM 2016 SP1 Service and Portal**, as described in https://docs.microsoft.com/en-us/microsoft-identity-manager/deploy-use/install-mim-service-portal 

36.   Close all open Internet Explorer windows.
37.   Start **File Explorer** and dismount any existing ISO images. Next, mount the ISO file residing in the **F:\\Tools\\MIM2016SP1** folder. Identify the drive letter of the mounted ISO file.
38.   From the **Administrator: Command Prompt** window, set the current directory to the root of the drive representing the mounted MIM 2016 SP1 installation media and run the following:

```
.\Service and Portal\setup.exe
```

39.   Step through the installation wizard. When prompted, accept the terms in the License Agreement and ensure that the option **I don’t want to join the program at this time** on the **MIM Customer Experience Improvement Program** page is not selected.
40.   On the **Custom Setup** page of the **Microsoft Identity Manager 2016 – Service and Portal** wizard, ensure that only the following components are selected:

  -   **MIM Service\\Privileged Access Management**
  -   **MIM Portal**

41.   On the **Configure Common Services – Configure** the MIM database connection page, ensure that the following entries are set.

  -   Database Server: **PAM-SVR1**
  -   Database Name: **FIMService**
  -   **Create a new database**

42.   On the **Configure Common Services – Configure mail server connection** page, set the email server to **adatum.com**, uncheck the **Use SSL** and **Mail Server is Exchange Server 2007 or Exchange Server 2010** checkboxes.
43.   On the **Configure Common Services – Configure server certificate** page, accept the default option **Generate a new self-issued certificate**.
44.   On the **Configure Common Services – Configure the MIM service account** page, ensure that the following entries are set.

  -   Service Account Name: **MIMService**
  -   Service Account Password: **Pa55w.rd**
  -   Service Account Domain: **PRIV**
  -   Service Email Account: **MIMService@priv.adatum.com**

45.   On the **Configure Common Services – Configure the Microsoft Identity Manager Service and Portal synchronization** page, ensure that the following entries are set.

  -   Synchronization Server: **PAM-SVR1**
  -   MIM Management Agent Account: **PRIV\\MIMMA**

46.   On the **Configure Common Services – Configure the Microsoft Identity Manager Service and Portal synchronization** page, note the warning message.

  > **Note:** The warning message informs that the MIM synchronization service does not exist on PAM-SVR1. This can be ignored since the MIM synchronization service is not used in this scenario.

47.   On the **Configure MIM Service and Portal** page, set **MIM Service Server Address** to **PAM-SVR1**.
48.   On the **Configure MIM Service and Portal** page, set **SharePoint site collection URL** to http://pam-svr1.priv.adatum.com:82.
49.   On the **Configure MIM Service and Portal** page, leave the **Registration Portal URL** text box blank.
50.   On the **Configure MIM Service and Portal Configure security changes configured by setup** page, select the checkbox to **Open ports 5725 and 5726 in firewall**, and the checkbox to **Grant all authenticated users access to the MIM portal site**.
51.   On the **Configure Privileged Access Management REST API** page, leave the **Host Name** text box empty, set **8086** as the port number.
52.   On the **Configure Privileged Access Management REST API** page, specify the following settings.

  -   Application Pool Account Name: **SharePoint**
  -   Application Pool Account Password: **Pa55w.rd**
  -   Application Pool Account Domain: **PRIV**

53.   On the **Configure the PAM Component Service** page, specify the following settings and click **Next**.

  -   Service Account Name: **MIMComponent**
  -   Service Account Password: **Pa55w.rd**
  -   Service Account Domain: **PRIV**

54.   On the **Configure the Privileged Access Management Monitoring Service** page, specify the following settings and click **Next**.

  -   Service Account Name: **MIMMonitor**
  -   Service Account Password: **Pa55w.rd**
  -   Service Account Domain: **PRIV**

55.   On the **Enter Information for MIM Password Portals** page, leave the checkboxes **MIM Password Registration Portal will be installed on another host** and **MIM Password Reset Portal will be installed on another host** cleared and click **Next**
56.   On the **Install Identity Manager Service and Portal** page, click **Install**.
57.   Once the installation completes, on the **Completed the Microsoft Identity Manager Service and Portal Setup Wizard** page, click **Finish ** and then, when prompted, restart the server. 
 
  > **Note:** At this point you are ready to set up MIM Portal management policy rules.

58.   Log back on with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

59.   Start Internet Explorer and navigate to the MIM Portal at http://pam-svr1.priv.adatum.com:82/identitymanagement. If prompted, sign in as **PRIV\\MIMAdmin**
60.   In the **MIM Portal**, click **Management Policy Rules**.
61.   Search for the management policy rule **User management: Users can read attributes of their own** and enable it. 
62.   Use **Windows Firewall with Advanced Security** to verify that the following two inbound rules are enabled: 

  -   **Forefront Identity Manager Service (STS)**
  -   **Forefront Identity Manager Service (Webservice) **

63.   Create a new port rule named **Forefront Identity Manager Service (8086 8090)** applicable to the **domain**, **public**, and **private** profile that allows inbound connections to **TCP** ports **8086** and **8090**. 

  > **Note:** Next, you will install a sample MIM REST API application.

64.   Locate the archive file containing Identity Management sample code in the **F:\\Tools\\MIMSample** folder. 

  > **Note:** The archive is also available from https://github.com/Azure/identity-management-samples

65.   Unpack the contents of the folder **identity-management-samples-master\\Privileged-Access-Management-Portal\\src** into a new folder **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management Portal**.
66.   Start **Windows PowerShell** as **Administrator**. 
67.   From the **Administrator: Windows PowerShell** prompt, create new web site with a site name **MIM Privileged Access Management Example Portal**, physical path **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management Portal**, and port **8090 ** by running the following PowerShell cmdlet (F:\\Labfiles\\Scripts\\Ex1Task3-09.ps1):

```
New-WebSite -Name "MIM Privileged Access Management Example Portal" -Port 8090 -PhysicalPath "C:\Program Files\Microsoft Forefront Identity Manager\2010\Privileged Access Management Portal\"
```

68.   Set up the sample web application to redirect users to the MIM PAM REST API. To accomplish this, first open the open the file **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management REST API\\web.config** in Notepad by running the following from the **Administrator: Windows PowerShell** prompt:

```
Notepad “C:\Program Files\Microsoft Forefront Identity Manager\2010\Privileged Access Management REST API\web.config"
```

69.   In the section **<system.webServer>**, add the following lines following </handlers> (F:\\Labfiles\\Scripts\\Ex1Task3-10.txt):

```
<httpProtocol>
 <customHeaders>
  <add name="Access-Control-Allow-Credentials" value="true" />
  <add name="Access-Control-Allow-Headers" value="content-type" />
  <add name="Access-Control-Allow-Origin" value="http://pam-svr1:8090" />  
 </customHeaders>
</httpProtocol>
```

70.   Save and close the **web.config** file.
71.   Open **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Privileged Access Management Portal\\js\\utils.js** in Notepad, verify that the value of **pamRespApiUrl** is set to http://pam-svr1.priv.adatum.com:8086/api/pamresources/, and close the file.
72.   Restart IIS by running the following from the **Administrator: Windows PowerShell** prompt:

```
iisreset
```

73.   To verify that the user can authenticate to the REST API, start **Internet Explorer** and navigate to http://pam-svr1.priv.adatum.com:8086/api/pamresources/pamroles/ . If prompted, authenticate as **PRIV\\MIMAdmin** with **Pa55w.rd** as the password. Ensure that you are prompted to open or save **pamroles.json**. 


#### Task 4: Prepare LON-CL1

In this task, you will perform the following actions on LON-CL1:

-   Install and configure PAM MIM add-ins and extensions

1.   Sign in to the LON-CL1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Command Prompt** as Administrator and, from the Command Prompt window, run **F:\\Tools\\MIM2016SP1\\Add-ins and extensions\\x64\setup.exe**
3.   Step through the installation wizard. When prompted, accept the License Agreement terms and ensure that the option **I don’t want to join the program at this time on the MIM Customer Experience Improvement Program** is selected.
4.   On the **Custom Setup** page of the installation wizard, select to install the **PAM Client** but deselect the **MIM Add-in for Outlook** and the **MIM Password and Authentication Extensions**.
5.   On the **Configure MIM PAM Service Address** of the installation wizard, set the **PAM Server Address** to **pam-svr1.priv.adatum.com** and accept the default Port value.
6.   After the installation completes, restart LON-CL1.

#### Task 5: Establish trust between the ADATUM and PRIV Active Directory forests

In this task, you will perform the following task

-   establish a PAM-based trust between the PRIV and ADATUM AD forests 

1.   While logged on to the PAM-SVR1 lab virtual machine as PRIV\\MIMAdmin, from **Administrator: Windows PowerShell ISE**, run the following (F:\\Labfiles\\Scripts\\Ex1Task5-01.ps1):

```
$ca = Get-Credential
New-PAMTrust -SourceForest "adatum.com" -Credentials $ca
```

When prompted, type in credentials of the member of the Domain Admins group in the ADATUM domain (**ADATUM\\Administrator** with the password **Pa55w.rd**)

2.   Switch to the LON-DC1 lab virtual machine where you are signed on as ADATUM\\Administrator
3.   On LON-DC1, switch to the **Group Policy Management** console.
4.   From the **Group Policy Management** console, edit the **Default Domain Controllers Policy** GPO by modifying the following setting:

  -   Computer Configuration > Policies > Administrative Templates > System > Remote Procedure Call > Enable RPC Endpoint Mapper Client Authentication: set to **Disabled**.

  > **Note:** This is necessary to account for the behavior described in https://blogs.technet.microsoft.com/the_9z_by_chris_davis/2016/11/22/dns-isnt-always-the-cause-of-selected-objects-in-the-following-domains-are-not-available/ 

5.   Force the update of the group policy. 
6.   From the Command Prompt window, run the following (F:\\Labfiles\\Scripts\\Ex1Task5-02.cmd):

```
netdom trust adatum.com /domain:priv.adatum.com /enablesidhistory:yes /usero:ADATUM\administrator /passwordo:Pa55w.rd
netdom trust adatum.com /domain:priv.adatum.com /quarantine:no /userd:PRIV\administrator /passwordd:Pa55w.rd
netdom trust adatum.com /domain:priv.adatum.com /enablepimtrust:yes /usero:ADATUM\administrator /passwordo:Pa55w.rd
```

  > **Note:** This commands enable SID history and disables SID filtering for the trust as well as enables PIM trust.

7.   Start **Active Directory Users and Computers**. 
8.   From the **Active Directory Users and Computers** console, delegate  **Read all user information** permissions in the **ADATUM** domain to **PRIV\\Domain Admins;PRIV\\MIMMonitor** 

> **Result**: After completing this exercise, you have implemented infrastructure necessary to support PAM and JIT in the bastion forest scenario.


## Exercise 2: Testing PAM and JIT

The main task for this exercise are:

1.   Create privileged accounts
2.   Elevate access via PAM

#### Task 1: Create privileged accounts

In this task, you will perform the following actions:
-   Create a PAM user in the PRIV domain
-   Create a PAM shadow security group in the PRIV domain corresponding to the ADATUM\CorpAdmin group
-   Create a PAM role associated with the ADATUM\CorpAdmin security group 

1.   Switch to the PAM-SVR1 lab virtual machine and ensure that you are logged on with the following credentials:

  -   USERNAME: **PRIV\\MIMAdmin**
  -   PASSWORD: **Pa55w.rd**

2.   Start **Windows PowerShell ISE** as **Administrator**.
3.   From the **Administrator: Windows PowerShell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task1-01.ps1):

```
$su = New-PAMUser –SourceDomain adatum.com –SourceAccountName CorpAdmin01
$sp = ConvertTo-SecureString –AsPlaintext 'Pa55w.rd' –Force
Set-ADAccountPassword –Identity PRIV.CorpAdmin01 –NewPassword $sp -Reset
Set-ADUser –Identity PRIV.CorpAdmin01 –Enabled 1
```

4.   From the **Administrator: Windows PowerShell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task1-02.ps1):

```
$casp = ConvertTo-SecureString –AsPlaintext 'Pa55w.rd' –Force
$ca = New-Object –TypeName System.Management.Automation.PSCredential –ArgumentList ‘ADATUM\Administrator’,$casp
$pg = New-PAMGroup –SourceGroupName "CorpAdmins" –SourceDomain adatum.com –SourceDC LON-DC1.adatum.com –Credentials $ca
$pr = New-PAMRole –DisplayName "CorpAdmins" –Privileges $pg –Candidates $su
```

  > **Note:** This script copies the group ADATUM\\CorpAdmins with its group membership to the PRIV domain. Note that the group is not directly visible in the Active Directory Users and Computers console (unlike the PAM user, which appears in the PAM Objects Organizational Unit), since it is stored in the Configuration partition of Active Directory (you can actually view it in the Active Directory Sites and Services if you display the Services node). However, you can display its properties by using the Get-PAMGroup cmdlet.

#### Task 2: Elevate access via PAM

In this task, you will perform the following actions:
-   Remove ADATUM\CorpAdmin01 from the ADATUM\CorpAdmin security group (this is necessary to demonstrate the elevation process).
-   Sign in as ADATUM\CorpAdmin01 to LON-CL1 and verify that you do not have access to the corpfs file share.
-   Submit a request for assignment of the CorpAdmins PAM role.
-   Start a new PowerShell session as PRIV\PRIV.CorpAdmin01 and verify that you do have access to the corpfs file share
-   Examine properties of the PAM user, group, and role.

1.   Switch to LON-DC1 and start **Windows PowerShell** as **Administrator**.
2.   From the **Administrator: Windows PowerShell** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task2-01.ps1):

```
Remove-ADGroupMember -Identity 'CorpAdmins' -Members 'CorpAdmin01' –Confirm:$false
```

3.   Sign in to the LON-CL1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\CorpAdmin01**
  -   PASSWORD: **Pa55w.rd**

4.   Start **Command Prompt** as Administrator.
5.   From the **Administrator: Command Prompt** window, run the following:

```
dir \\LON-DC1.adatum.com\corpfs
```

  > **Note:** Ensure that the command triggers the **Access is denied** message. This is expected since ADATUM\\CorpAdmin01 is no longer a member of the ADATUM\\CorpAdmins group

6.   From the Command Prompt window, run the following:

```
runas /user:PRIV.CorpAdmin01@priv.adatum.com powershell
```

7.   When prompted, authenticate by providing the password **Pa55w.rd** of the **PRIV\\PRIV.CorpAdmin01** user account. This will automatically open a new Windows PowerShell window.
8.   From the Windows PowerShell prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task2-02.ps1):

```
$r = Get-PAMRoleForRequest | Where-Object { $_.DisplayName –eq "CorpAdmins" }
New-PAMRequest –Role $r
```

  > **Note:** This command generates a request for assignment of the CorpAdmins PAM role. The output of the command displays the settings of the CorpAdmins role. Note the value of the TTL property of the role, which determines the duration of access associated with the role through its domain groups (CorpAdmins in our case).

9.   From the Windows PowerShell prompt, run the following:

```
klist purge
```

  > **Note:** This command purges tickets in the Kerberos ticket cache to eliminate any potential impact they might have on privileges of CorpAdmin01.

10.   Close the Windows PowerShell window.
11.   From the Command Prompt window, run again the following:

```
runas /user:PRIV.CorpAdmin01@priv.adatum.com powershell
```

12.   When prompted, authenticate by providing the password **Pa55w.rd** of the **PRIV\\PRIV.CorpAdmin01** user account. This will automatically open a new Windows PowerShell window.
13.   From the Windows PowerShell prompt, run the following: 

```
whoami /groups
dir \\LON-DC1.adatum.com\corpfs
```

  > **Note:** Ensure that this time there is no **Access is denied** message. This is expected since, as the output of whoami /groups indicate, you are operating now as a member of the ADATUM\\CorpAdmins group

14.   Switch to the PAM-SVR1 lab virtual machine.
15.   From the **Administrator: Windows PowerShell ISE** prompt, run the following (F:\\Labfiles\\Scripts\\Ex2Task2-03.ps1):

```
$user = Get-PAMUser -SourceAccountName CorpAdmin01 -SourceDomain ADATUM
Get-PAMRequest -User $user
```

  > **Note:** The cmdlet lists all requests (active, closed, and expired) submitted by ADATUM\\CorpAdmin01 user (via its PRIV\\PRIV.CorpAdmin01 security principal (to list only the active ones, you can simply add the –Active switch). Note the expiration time of the request. 

16.   Switch to the PAM-DC1 lab virtual machine.
17.   Start **Active Directory Users and Computers**. 
18.   Navigate to the **PAM objects** organizational unit and examine the membership of the **PRIV.CorpAdmin01** user account. 

  > **Note:** Verify that PRIV.CorpAdmin01 is currently a member of the ADATUM\\CorpAdmins shadow security group. The user will be automatically removed from the group after 1 hour.

> **Result**: After completing this exercise, you have created the PAM user, group, and role in the PRIV forest and tested their functionality from the ADATUM forest.


©2016 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply.  All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant.  This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  